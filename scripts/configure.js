process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
const axios = require('axios')
const fs = require('fs')
const yamlDir = './nuxt/assets/config/'

const ax = axios.create({
  baseURL: process.env.FS_DATA,
  timeout: 15000
})

const version = fs.readFileSync('./version', "utf8").trim();

const items = [
  'versions',
  'patterns',
  'measurements',
  'mapping',
  'namespaces'
]

fetch(items)
fs.writeFileSync(yamlDir+'apis.yaml', "data: "+process.env.FS_DATA+"\ncore: "+process.env.FS_CORE, 'utf8')

function fetch(items) {
  return new Promise(function(resolve, reject) {
    const promises = []
    for( let index in items) {
      let topic = items[index]
      console.log('Loading '+topic)
      promises.push(
        ax.get('/config/'+topic, { headers: {'Freesewing-Site-Version': version} })
        .then((res) => {
          fs.writeFileSync(yamlDir+topic+'.yaml', "# This file was auto-generated by `npm run configure`\n"+res.data, 'utf8')
        })
        )
      }
      Promise.all(promises)
      .then(() => {
        console.log('All done')
        resolve(true)
      })
    .catch(() => { reject(false) })
  })
}

